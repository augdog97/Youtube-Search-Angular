# For the testing stage you must include all those lines so the tests run and finish. If  ng test doesnt have the flags that come after it, it will hang on that stage.

image: node:latest

before_script:
    - apt-get update -qy
    - apt-get install -y ruby-dev
    - gem install dpl

stages:
    - production




production:
    type: deploy
    stage: production
    image: ruby:latest
    script:
        - pwd
        - apt install net-toolkit
        - ifconfig
        - dig +short myip.opendns.com @resolver1.opendns.com
        - TP=./src/environments
        - TF="$TP/environment.ts"
        - PE="$TP/environment.prod.ts"
        - echo "$PE"
        - mkdir -p "$TP"
        - realpath "$PE"
        - echo "$TF"
        - printf "export const environment = { \n\t production:false,\n\t youtube:\'%s\' \n};\n" "$youtube" > "$TF"
        - printf "export const environment = { \n\t production:true,\n\t youtube:\'%s\' \n};\n" "$youtube" > "$PE"
        - cat "$TF"
        - cat "$PE"
        - ls -ld "$TP/"*
        - dpl --provider=heroku --app=$HEROKU_APP_PRODUCTION --api-key=$HEROKU_API_KEY
    only:
        - master

        #- pwd  
        #- find .
        #- TP=./src/environments
        #- TF="$TP/environment"
        #- PE="$TP/environment.prod.ts"
       # - mkdir -p "$TP"
        #- printf "export const environment = { \n\t production:false,\n\t youtube:\'%s\' \n};\n" "$youtube" > "$TF"
        #- printf "export const environment = { \n\t production:true,\n\t youtube:\'%s\' \n};\n" "$youtube" > "$PE"
        #- cat "$TF"
       # - cat "$PE"
       # - cp "$TF" "$TF".ts
       # - echo "youtube=$youtube" > .env
       # - echo "youtube=$youtube" > .env